# Nomad Enterprise HVD on AWS EC2

Terraform module aligned with HashiCorp Validated Designs (HVD) to deploy Nomad Enterprise on Amazon Web Services (AWS) using EC2 instances.

## Prerequisites

### General

- Knowledge of Terraform and AWS
- Terraform CLI `>= 1.9` installed on client/workstations
- An AWS account with permissions to provision [resources](#resources) via Terraform
- `git` CLI and Visual Studio Code recommended on workstations

### Networking

- AWS VPC ID and the following subnets:
  - Subnets for the EC2 instances (compute)

>üìù Note: Specify at least two subnets for high availability.

#### Security groups

- This module will create security groups for EC2 instances.
- Define CIDR ranges for Nomad access, managed via the input variable `cidr_allow_ingress_nomad`.

### TLS certificates

TLS certificates for Nomad have very specific requirements for server and client nodes. [Nomad Agent Certificates](https://developer.hashicorp.com/nomad/tutorials/transport-security/security-enable-tls#agent-certificates) Let's Encrypt Certificates can not be used for Nomad due to the Nomad specific requirements. This module has the option to not enable TLS with `nomad_tls_enabled` however this should never be used outside a lab environment.

- TLS certificate (_e.g._ `cert.pem`) and private key (_e.g._ `privkey.pem`) for the Nomad web UI, in PEM format.
  - TLS private key must **not** be password-protected.
- TLS certificate authority (CA) bundle (_e.g._ `ca_bundle.pem`) in PEM format.
- These TLS files will be stored as secrets in AWS Secrets Manager.

>üìù Store these TLS files as AWS Secrets Manager secrets to securely manage your certificates.

### Gossip encryption

Gossip Encryption is required for this module. A Gossip Encryption Key can be generated by the Nomad CLI with `nomad operator gossip keyring generate`. Create this before deploying the module and store this in AWS Secrets Manager.

### Secrets management

The following secrets must be stored in **AWS Secrets Manager** to bootstrap the Nomad Server deployment:

- **Nomad license** - text string used for Nomad Enterprise licensing - This is only needed for Nomad Server deployment
- **Nomad Gossip Encryption Key** - text string generated by `nomad operator gossip keyring generate` - This is only needed for Nomad Server deployment
- **Nomad TLS certificate and private key** - stored as base64-encoded PEM secrets in AWS Secrets Manager

>üìù See the Nomad documentation for more details on securing these secrets in AWS Secrets Manager.

## Usage

1. Configure the [prerequisites](#prerequisites).

2. In the `examples` directory, you‚Äôll find subdirectories with ready-made Terraform configurations for deploying this module. Select an example that matches your use case, and copy its contents to a new directory.

    >üìù Example structure for managing multiple Nomad deployments:

    ```pre
    .
    ‚îî‚îÄ‚îÄ environments
        ‚îú‚îÄ‚îÄ production
        ‚îÇ   ‚îú‚îÄ‚îÄ backend.tf
        ‚îÇ   ‚îú‚îÄ‚îÄ main.tf
        ‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf
        ‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfvars
        ‚îÇ   ‚îî‚îÄ‚îÄ variables.tf
        ‚îî‚îÄ‚îÄ sandbox
            ‚îú‚îÄ‚îÄ backend.tf
            ‚îú‚îÄ‚îÄ main.tf
            ‚îú‚îÄ‚îÄ outputs.tf
            ‚îú‚îÄ‚îÄ terraform.tfvars
            ‚îî‚îÄ‚îÄ variables.tf
    ```

    >üìù This example has two separate Nomad deployments: one for a `sandbox` environment and one for a `production` environment.

3. (Optional) If using S3 for remote state, configure the `backend.tf` file with custom values.

4. Update the `terraform.tfvars` file with your custom values, then run `terraform init`, `terraform plan`, and `terraform apply`.

5. After `terraform apply` completes successfully, connect to the Nomad EC2 instance shell using SSH or AWS SSM to monitor the cloud-init logs:

    **Connecting to EC2 instance:**

    ```sh
    ssh -i /path/to/ec2_ssh_key_pair.pem ubuntu@<ec2-private-ip>
    ```

    **Viewing logs:**

    ```sh
    tail -f /var/log/nomad-cloud-init.log
    ```

6. Once the installation finishes, verify the health of the Nomad cluster by checking the Nomad Web UI or by running:

    ```sh
    nomad server members
    ```

7. If `nomad_acl_enabled` is `true` the Nomad cluster will need to be bootstrapped with the command `nomad acl bootstrap`. This will generate a bootstrap token that can be used to login to the CLI or UI.

## Docs

Additional documentation for managing and customizing your Nomad deployment is available in the `docs` folder:

- Nomad Version Upgrades
- Nomad TLS Certificate Rotation
- Nomad Configuration Settings
- Nomad Deployment Customizations

## Module support

This open source software is maintained by the HashiCorp Technical Field Organization, independently of our enterprise products. While our Support Engineering team provides dedicated support for our enterprise offerings, this open source software is not included.

- For help using this open source software, please engage your account team.
- To report bugs/issues with this open source software, please open them directly against this code repository using the GitHub issues feature.

Please note that there is no official Service Level Agreement (SLA) for support of this software as a HashiCorp customer. This software falls under the definition of Community Software/Versions in your Agreement. We appreciate your understanding and collaboration in improving our open source projects.

<!-- BEGIN_TF_DOCS -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.9 |
| <a name="requirement_aws"></a> [aws](#requirement\_aws) | >= 5.51.0 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_aws"></a> [aws](#provider\_aws) | >= 5.51.0 |

## Resources

| Name | Type |
|------|------|
| [aws_autoscaling_group.nomad](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/autoscaling_group) | resource |
| [aws_iam_instance_profile.nomad_ec2](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_instance_profile) | resource |
| [aws_iam_role.nomad_ec2](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role) | resource |
| [aws_iam_role_policy.nomad_ec2](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy) | resource |
| [aws_iam_role_policy_attachment.aws_ssm](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment) | resource |
| [aws_launch_template.nomad](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/launch_template) | resource |
| [aws_lb.nlb](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb) | resource |
| [aws_lb_listener.nlb_443](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_listener) | resource |
| [aws_lb_listener.nlb_80](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_listener) | resource |
| [aws_lb_target_group.nlb_4646](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_target_group) | resource |
| [aws_placement_group.nomad](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/placement_group) | resource |
| [aws_route53_record.alias_record](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route53_record) | resource |
| [aws_security_group.ec2_allow_ingress](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group) | resource |
| [aws_security_group.egress](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group) | resource |
| [aws_security_group.lb_allow_egress](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group) | resource |
| [aws_security_group.lb_allow_ingress](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group) | resource |
| [aws_security_group.nomad_rpc](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group) | resource |
| [aws_security_group_rule.ec2_allow_ingress_nomad_from_cidr](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule) | resource |
| [aws_security_group_rule.ec2_allow_ingress_nomad_from_lb](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule) | resource |
| [aws_security_group_rule.lb_allow_egress_all](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule) | resource |
| [aws_security_group_rule.lb_allow_ingress_nomad_from_cidr](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule) | resource |
| [aws_security_group_rule.lb_allow_ingress_nomad_from_ec2](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule) | resource |
| [aws_ami.al2023](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ami) | data source |
| [aws_ami.provided](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ami) | data source |
| [aws_ami.rhel](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ami) | data source |
| [aws_ami.ubuntu](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ami) | data source |
| [aws_iam_policy_document.assume_role_policy](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_iam_policy_document.combined](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_iam_policy_document.gossip_encryption_key](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_iam_policy_document.license](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_iam_policy_document.nomad_discovery](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_iam_policy_document.tls_ca](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_iam_policy_document.tls_cert](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_iam_policy_document.tls_privkey](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_route53_zone.nomad](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/route53_zone) | data source |
| [aws_vpc.cluster](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/vpc) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_friendly_name_prefix"></a> [friendly\_name\_prefix](#input\_friendly\_name\_prefix) | Friendly name prefix used for uniquely naming AWS resources. | `string` | n/a | yes |
| <a name="input_instance_subnets"></a> [instance\_subnets](#input\_instance\_subnets) | List of AWS subnet IDs for instance(s) to be deployed into. | `list(string)` | n/a | yes |
| <a name="input_key_name"></a> [key\_name](#input\_key\_name) | SSH key name, already registered in AWS, to use for instance access | `string` | n/a | yes |
| <a name="input_nomad_client"></a> [nomad\_client](#input\_nomad\_client) | Boolean to enable the Nomad client agent. | `bool` | n/a | yes |
| <a name="input_nomad_datacenter"></a> [nomad\_datacenter](#input\_nomad\_datacenter) | Specifies the data center of the local agent. A datacenter is an abstract grouping of clients within a region. Clients are not required to be in the same datacenter as the servers they are joined with, but do need to be in the same region. | `string` | n/a | yes |
| <a name="input_nomad_server"></a> [nomad\_server](#input\_nomad\_server) | Boolean to enable the Nomad server agent. | `bool` | n/a | yes |
| <a name="input_region"></a> [region](#input\_region) | AWS region where Nomad will be deployed. | `string` | n/a | yes |
| <a name="input_vpc_id"></a> [vpc\_id](#input\_vpc\_id) | ID of the AWS VPC resources are deployed into. | `string` | n/a | yes |
| <a name="input_additional_package_names"></a> [additional\_package\_names](#input\_additional\_package\_names) | List of additional repository package names to install | `set(string)` | `[]` | no |
| <a name="input_additional_security_group_ids"></a> [additional\_security\_group\_ids](#input\_additional\_security\_group\_ids) | List of AWS security group IDs to apply to all cluster nodes. | `list(string)` | `[]` | no |
| <a name="input_asg_health_check_grace_period"></a> [asg\_health\_check\_grace\_period](#input\_asg\_health\_check\_grace\_period) | The amount of time to wait for a new Nomad EC2 instance to become healthy. If this threshold is breached, the ASG will terminate the instance and launch a new one. | `number` | `600` | no |
| <a name="input_associate_public_ip"></a> [associate\_public\_ip](#input\_associate\_public\_ip) | Whether public IPv4 addresses should automatically be attached to cluster nodes. | `bool` | `false` | no |
| <a name="input_autopilot_health_enabled"></a> [autopilot\_health\_enabled](#input\_autopilot\_health\_enabled) | Whether autopilot upgrade migration validation is performed for server nodes at boot-time | `bool` | `true` | no |
| <a name="input_cidr_allow_ingress_nomad"></a> [cidr\_allow\_ingress\_nomad](#input\_cidr\_allow\_ingress\_nomad) | List of CIDR ranges to allow ingress traffic on port 443 or 80 to Nomad server or load balancer. | `list(string)` | <pre>[<br/>  "0.0.0.0/0"<br/>]</pre> | no |
| <a name="input_cni_version"></a> [cni\_version](#input\_cni\_version) | Version of CNI plugin to install. | `string` | `"1.6.0"` | no |
| <a name="input_common_tags"></a> [common\_tags](#input\_common\_tags) | Map of common tags for taggable AWS resources. | `map(string)` | `{}` | no |
| <a name="input_create_nlb"></a> [create\_nlb](#input\_create\_nlb) | Boolean to create a Network Load Balancer for Nomad. | `bool` | `true` | no |
| <a name="input_create_route53_nomad_dns_record"></a> [create\_route53\_nomad\_dns\_record](#input\_create\_route53\_nomad\_dns\_record) | Boolean to create Route53 Alias Record for `nomad_hostname` resolving to Load Balancer DNS name. If `true`, `route53_hosted_zone_nomad` is also required. | `bool` | `false` | no |
| <a name="input_data_ebs_iops"></a> [data\_ebs\_iops](#input\_data\_ebs\_iops) | Amount of IOPS to configure when EBS volume type is `gp3`. Must be greater than or equal to `3000` and less than or equal to `16000`. | `number` | `3000` | no |
| <a name="input_data_ebs_throughput"></a> [data\_ebs\_throughput](#input\_data\_ebs\_throughput) | Throughput (MB/s) to configure when data EBS volume type is `gp3`. Must be greater than or equal to `125` and less than or equal to `1000`. | `number` | `250` | no |
| <a name="input_data_ebs_volume_size"></a> [data\_ebs\_volume\_size](#input\_data\_ebs\_volume\_size) | Size (GB) of the data EBS volume for Nomad EC2 instances. Must be greater than or equal to `50` and less than or equal to `16000`. | `number` | `50` | no |
| <a name="input_data_ebs_volume_type"></a> [data\_ebs\_volume\_type](#input\_data\_ebs\_volume\_type) | EBS volume type for data Nomad EC2 instances vol. | `string` | `"gp3"` | no |
| <a name="input_ebs_is_encrypted"></a> [ebs\_is\_encrypted](#input\_ebs\_is\_encrypted) | Boolean to encrypt the EBS root block device of the Nomad EC2 instance(s). An AWS managed key will be used when `true` unless a value is also specified for `ebs_kms_key_arn`. | `bool` | `true` | no |
| <a name="input_ebs_kms_key_arn"></a> [ebs\_kms\_key\_arn](#input\_ebs\_kms\_key\_arn) | ARN of KMS customer managed key (CMK) to encrypt Nomad EC2 EBS volumes. | `string` | `null` | no |
| <a name="input_ec2_allow_ssm"></a> [ec2\_allow\_ssm](#input\_ec2\_allow\_ssm) | Boolean to attach the `AmazonSSMManagedInstanceCore` policy to the Nomad instance role, allowing the SSM agent (if present) to function. | `bool` | `false` | no |
| <a name="input_ec2_ami_id"></a> [ec2\_ami\_id](#input\_ec2\_ami\_id) | AMI to launch ASG instances from. | `string` | `null` | no |
| <a name="input_ec2_os_distro"></a> [ec2\_os\_distro](#input\_ec2\_os\_distro) | Linux OS distribution type for Nomad EC2 instance. Choose from `al2023`, `ubuntu`, `rhel`, `centos`. | `string` | `"ubuntu"` | no |
| <a name="input_instance_type"></a> [instance\_type](#input\_instance\_type) | EC2 instance type to launch. | `string` | `"m5.large"` | no |
| <a name="input_lb_is_internal"></a> [lb\_is\_internal](#input\_lb\_is\_internal) | Boolean to create an internal (private) load balancer. The `lb_subnet_ids` must be private subnets when this is `true`. | `bool` | `true` | no |
| <a name="input_lb_subnet_ids"></a> [lb\_subnet\_ids](#input\_lb\_subnet\_ids) | List of subnet IDs to use for the load balancer. If `lb_is_internal` is `false`, then these should be public subnets. Otherwise, these should be private subnets. | `list(string)` | `null` | no |
| <a name="input_nomad_acl_enabled"></a> [nomad\_acl\_enabled](#input\_nomad\_acl\_enabled) | Boolean to enable ACLs for Nomad. | `bool` | `true` | no |
| <a name="input_nomad_architecture"></a> [nomad\_architecture](#input\_nomad\_architecture) | Architecture of the Nomad binary to install. | `string` | `"amd64"` | no |
| <a name="input_nomad_fqdn"></a> [nomad\_fqdn](#input\_nomad\_fqdn) | Fully qualified domain name of the Nomad Cluster. This name should resolve to the load balancer IP address and will be what admins will use to access Nomad. | `string` | `null` | no |
| <a name="input_nomad_gossip_encryption_key_secret_arn"></a> [nomad\_gossip\_encryption\_key\_secret\_arn](#input\_nomad\_gossip\_encryption\_key\_secret\_arn) | ARN of AWS Secrets Manager secret for Nomad gossip encryption key. | `string` | `null` | no |
| <a name="input_nomad_license_secret_arn"></a> [nomad\_license\_secret\_arn](#input\_nomad\_license\_secret\_arn) | ARN of AWS Secrets Manager secret for Nomad license file. | `string` | `null` | no |
| <a name="input_nomad_nodes"></a> [nomad\_nodes](#input\_nomad\_nodes) | Number of Nomad nodes to deploy. | `number` | `6` | no |
| <a name="input_nomad_region"></a> [nomad\_region](#input\_nomad\_region) | Specifies the region of the local agent. A region is an abstract grouping of datacenters. Clients are not required to be in the same region as the servers they are joined with, but do need to be in the same datacenter. If not specified, the region is set AWS region. | `string` | `null` | no |
| <a name="input_nomad_tls_ca_bundle_secret_arn"></a> [nomad\_tls\_ca\_bundle\_secret\_arn](#input\_nomad\_tls\_ca\_bundle\_secret\_arn) | ARN of AWS Secrets Manager secret for private/custom TLS Certificate Authority (CA) bundle in PEM format. Secret must be stored as a base64-encoded string. | `string` | `null` | no |
| <a name="input_nomad_tls_cert_secret_arn"></a> [nomad\_tls\_cert\_secret\_arn](#input\_nomad\_tls\_cert\_secret\_arn) | ARN of AWS Secrets Manager secret for Nomad TLS certificate in PEM format. Secret must be stored as a base64-encoded string. | `string` | `null` | no |
| <a name="input_nomad_tls_enabled"></a> [nomad\_tls\_enabled](#input\_nomad\_tls\_enabled) | Boolean to enable TLS for Nomad. | `bool` | `true` | no |
| <a name="input_nomad_tls_privkey_secret_arn"></a> [nomad\_tls\_privkey\_secret\_arn](#input\_nomad\_tls\_privkey\_secret\_arn) | ARN of AWS Secrets Manager secret for Nomad TLS private key in PEM format. Secret must be stored as a base64-encoded string. | `string` | `null` | no |
| <a name="input_nomad_ui_enabled"></a> [nomad\_ui\_enabled](#input\_nomad\_ui\_enabled) | Boolean to enable the Nomad UI. | `bool` | `true` | no |
| <a name="input_nomad_upstream_servers"></a> [nomad\_upstream\_servers](#input\_nomad\_upstream\_servers) | List of Nomad server addresses to join the Nomad client with. | `list(string)` | `null` | no |
| <a name="input_nomad_upstream_tag_key"></a> [nomad\_upstream\_tag\_key](#input\_nomad\_upstream\_tag\_key) | String of the tag key the Nomad client should look for in AWS to join with. Only needed for auto-joining the Nomad client. | `string` | `null` | no |
| <a name="input_nomad_upstream_tag_value"></a> [nomad\_upstream\_tag\_value](#input\_nomad\_upstream\_tag\_value) | String of the tag value the Nomad client should look for in AWS to join with. Only needed for auto-joining the Nomad client. | `string` | `null` | no |
| <a name="input_nomad_version"></a> [nomad\_version](#input\_nomad\_version) | Version of Nomad to install. | `string` | `"1.9.0+ent"` | no |
| <a name="input_permit_all_egress"></a> [permit\_all\_egress](#input\_permit\_all\_egress) | Whether broad (0.0.0.0/0) egress should be permitted on cluster nodes. If disabled, additional rules must be added to permit HTTP(S) and other necessary network access. | `bool` | `true` | no |
| <a name="input_root_ebs_iops"></a> [root\_ebs\_iops](#input\_root\_ebs\_iops) | Amount of IOPS to configure when root EBS volume type is `gp3`. Must be greater than or equal to `3000` and less than or equal to `16000`. | `number` | `3000` | no |
| <a name="input_root_ebs_throughput"></a> [root\_ebs\_throughput](#input\_root\_ebs\_throughput) | Throughput (MB/s) to configure when root EBS volume type is `gp3`. Must be greater than or equal to `125` and less than or equal to `1000`. | `number` | `250` | no |
| <a name="input_root_ebs_volume_size"></a> [root\_ebs\_volume\_size](#input\_root\_ebs\_volume\_size) | Size (GB) of the root EBS volume for Nomad EC2 instances. Must be greater than or equal to `50` and less than or equal to `16000`. | `number` | `50` | no |
| <a name="input_root_ebs_volume_type"></a> [root\_ebs\_volume\_type](#input\_root\_ebs\_volume\_type) | EBS volume type for root Nomad EC2 instances vol. | `string` | `"gp3"` | no |
| <a name="input_route53_nomad_hosted_zone_is_private"></a> [route53\_nomad\_hosted\_zone\_is\_private](#input\_route53\_nomad\_hosted\_zone\_is\_private) | Boolean indicating if `route53_nomad_hosted_zone_name` is a private hosted zone. | `bool` | `false` | no |
| <a name="input_route53_nomad_hosted_zone_name"></a> [route53\_nomad\_hosted\_zone\_name](#input\_route53\_nomad\_hosted\_zone\_name) | Route53 Hosted Zone name to create `nomad_hostname` Alias record in. Required if `create_nomad_alias_record` is `true`. | `string` | `null` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_nomad_cli_config"></a> [nomad\_cli\_config](#output\_nomad\_cli\_config) | Environment variables to configure the nomad CLI |
| <a name="output_nomad_url"></a> [nomad\_url](#output\_nomad\_url) | URL to access Nomad application based on value of `nomad_fqdn` input. |
<!-- END_TF_DOCS -->
